{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 244, "column": 0}, "map": {"version":3,"sources":["file:///Users/peterbassett/Documents/Projects/mcma-kitchen-volunteers/src/app/api/signup/route.js"],"sourcesContent":["import { google } from 'googleapis';\nimport { Resend } from 'resend';\n\nfunction formatPhone(phone) {\n  const digits = phone.replace(/\\D/g, '');\n  if (digits.length !== 10) throw new Error('Invalid phone number');\n  return `${digits.slice(0, 3)}-${digits.slice(3, 6)}-${digits.slice(6)}`;\n}\n\nfunction generateICS({ eventName, eventDate, name, email }) {\n  const now = new Date();\n  const [year, month, day] = eventDate.split('-').map(Number);\n  const weekday = new Date(year, month - 1, day).getDay();\n  const startHour = weekday === 6 ? 10 : 16;\n  const startMinute = 30;\n  const startDate = new Date(year, month - 1, day, startHour, startMinute);\n  const endDate = new Date(startDate.getTime() + 3 * 60 * 60 * 1000);\n  const format = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';\n\n  return `\nBEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//MCMA Kitchen//EN\nCALSCALE:GREGORIAN\nMETHOD:REQUEST\nBEGIN:VEVENT\nDTSTART:${format(startDate)}\nDTEND:${format(endDate)}\nDTSTAMP:${format(now)}\nSUMMARY:MCMA Kitchen – ${eventName}\nDESCRIPTION:Thanks for volunteering, ${name}!\nORGANIZER;CN=MCMA Kitchen:mailto:${process.env.ADMIN_EMAIL}\nATTENDEE;CN=${name};RSVP=TRUE:mailto:${email}\nLOCATION:MCMA Kitchen\nUID:${Date.now()}@mcmakitchen.org\nSTATUS:CONFIRMED\nSEQUENCE:0\nEND:VEVENT\nEND:VCALENDAR\n  `.trim();\n}\n\nfunction getGoogleCalendarURL({ eventName, eventDate, name }) {\n  const [year, month, day] = eventDate.split('-').map(Number);\n  const weekday = new Date(year, month - 1, day).getDay();\n  const startHour = weekday === 6 ? 10 : 16;\n  const startMinute = 30;\n  const start = new Date(year, month - 1, day, startHour, startMinute);\n  const end = new Date(start.getTime() + 3 * 60 * 60 * 1000);\n  const format = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';\n\n  const params = new URLSearchParams({\n    action: 'TEMPLATE',\n    text: `MCMA Kitchen – ${eventName}`,\n    dates: `${format(start)}/${format(end)}`,\n    details: `Volunteer sign-up for ${eventName}. Thanks, ${name}!`,\n    location: 'MCMA Kitchen',\n  });\n\n  return `https://www.google.com/calendar/render?${params.toString()}`;\n}\n\nexport async function POST(req) {\n  try {\n    const { eventName, eventDate, name, phone, email, token } = await req.json();\n    if (!eventName || !eventDate || !name || !phone || !email || !token) {\n      return new Response(JSON.stringify({ error: 'Missing fields' }), { status: 400 });\n    }\n\n    const captchaRes = await fetch('https://www.google.com/recaptcha/api/siteverify', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n      body: new URLSearchParams({\n        secret: process.env.RECAPTCHA_SECRET_KEY,\n        response: token,\n      }),\n    });\n    const captchaResult = await captchaRes.json();\n    if (!captchaResult.success || captchaResult.score < 0.5) {\n      console.warn('⚠️ CAPTCHA verification failed', { captchaResult });\n      return new Response(JSON.stringify({ error: 'Failed CAPTCHA verification' }), { status: 403 });\n    }\n\n    const formattedPhone = formatPhone(phone);\n\n    const auth = new google.auth.JWT(\n      process.env.GOOGLE_CLIENT_EMAIL,\n      null,\n      process.env.GOOGLE_PRIVATE_KEY.replace(/\\n/g, '\\n'),\n      ['https://www.googleapis.com/auth/spreadsheets']\n    );\n\n    const sheets = google.sheets({ version: 'v4', auth });\n    const sheetId = process.env.GOOGLE_SHEET_ID;\n    const now = new Date();\n    const formattedTimestamp = now.toLocaleString('en-US', {\n      timeZone: 'America/Los_Angeles',\n      weekday: 'long',\n      month: '2-digit',\n      day: '2-digit',\n      year: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n      hour12: true,\n    });\n\n    const [year, month, day] = eventDate.split('-').map(Number);\n    const parsedEventDate = new Date(year, month - 1, day);\n    const formattedEventDate = parsedEventDate.toLocaleDateString('en-US', {\n      timeZone: 'America/Los_Angeles',\n      weekday: 'long',\n      month: '2-digit',\n      day: '2-digit',\n      year: '2-digit',\n    });\n\n    const newRow = [\n      formattedTimestamp,\n      eventName,\n      eventDate,\n      name,\n      formattedPhone,\n      email,\n    ];\n\n    await sheets.spreadsheets.values.append({\n      spreadsheetId: sheetId,\n      range: 'Volunteer Signups!A:F',\n      valueInputOption: 'USER_ENTERED',\n      insertDataOption: 'INSERT_ROWS',\n      requestBody: {\n        values: [newRow],\n      },\n    });\n\n    const resend = new Resend(process.env.RESEND_API_KEY);\n    const calendarICS = generateICS({ eventName, eventDate, name, email });\n    const googleCalendarLink = getGoogleCalendarURL({ eventName, eventDate, name });\n\n    const logo = 'https://mcma.s3.us-east-1.amazonaws.com/mcmaLogo.png';\n    const adminEmail = process.env.ADMIN_EMAIL || 'hello@mcmakitchen.com';\n\n    const volunteerHeading = \"Thank you for signing up!\";\n    const volunteerIntro = `<p style=\"font-size:14px; color:#444; text-align:center; max-width:360px; margin:0 auto 24px;\">\n      We're excited to have you join us in the kitchen!  Below are the details of the volunteer shift you signed up for. We'll confirm with you shortly.\n    </p>`;\n\n    const volunteerHTML = `\n      <div style=\"font-family:sans-serif; background:#fff; padding:24px; border-radius:12px; border:1px solid #ddd; max-width:480px; margin:0 auto;\">\n        <div style=\"text-align:center;\">\n          <img src=\"${logo}\" alt=\"MCMA Logo\" style=\"max-width:100px; margin-bottom:16px;\" />\n        </div>\n        ${volunteerIntro}\n        <h2 style=\"text-align:center; color:#000;\">${volunteerHeading}</h2>\n        <p><strong>Event:</strong> ${eventName}</p>\n        <p><strong>Date:</strong> ${formattedEventDate}</p>\n        <p><strong>Name:</strong> ${name}</p>\n        <p><strong>Phone:</strong> ${formattedPhone}</p>\n        <p><strong>Email:</strong> <a href=\"mailto:${email}\" style=\"color:#007bff; text-decoration:none;\">${email}</a></p>\n        <div style=\"margin-top:24px; display:flex; gap:8px;\">\n          <a href=\"${googleCalendarLink}\" style=\"background:#007bff; color:#fff; padding:10px 16px; text-decoration:none; border-radius:6px; font-weight:bold;\">Add to Google Calendar</a>\n          <a href=\"cid:calendar\" style=\"background:#333; color:#fff; padding:10px 16px; text-decoration:none; border-radius:6px; font-weight:bold;\">Add to Apple Calendar</a>\n        </div>\n      </div>\n    `;\n\n    const adminHeading = \"Someone just signed up to help.\";\n    const adminHTML = volunteerHTML\n      .replace(volunteerIntro, '')\n      .replace(volunteerHeading, adminHeading);\n\n    const plainText = `\nThanks for signing up!\n\nEvent: ${eventName}\nDate: ${formattedEventDate}\nName: ${name}\nPhone: ${formattedPhone}\nEmail: ${email}\n`;\n\n    await resend.emails.send({\n      from: process.env.EMAIL_FROM,\n      to: email,\n      subject: `MCMA Kitchen – Thanks for signing up to help at the ${eventName} ${formattedEventDate}`,\n      html: volunteerHTML,\n      text: plainText,\n      reply_to: adminEmail,\n      attachments: [\n        {\n          filename: 'mcma-volunteer.ics',\n          content: calendarICS,\n          contentType: 'text/calendar',\n          contentDisposition: 'inline',\n          cid: 'calendar',\n        },\n      ],\n    });\n\n    await resend.emails.send({\n      from: process.env.EMAIL_FROM,\n      to: adminEmail,\n      subject: `New MCMA Volunteer Sign-Up: ${name} for ${eventName}`,\n      html: adminHTML,\n      text: plainText,\n      reply_to: adminEmail,\n    });\n\n    return new Response(JSON.stringify({\n      status: 'OK',\n      submitted: { eventName, formattedEventDate, name, formattedPhone, email }\n    }), { status: 200 });\n\n  } catch (err) {\n    console.error('❌ Signup Error:', err);\n    return new Response(JSON.stringify({ error: err.message }), { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}