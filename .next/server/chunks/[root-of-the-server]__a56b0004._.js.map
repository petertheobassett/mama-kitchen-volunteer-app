{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 244, "column": 0}, "map": {"version":3,"sources":["file:///Users/peterbassett/Documents/Projects/mcma-kitchen-volunteers/src/app/api/signup/route.js"],"sourcesContent":["import { google } from 'googleapis';\nimport { Resend } from 'resend';\n\nfunction formatPhone(phone) {\n  const digits = phone.replace(/\\D/g, '');\n  if (digits.length !== 10) throw new Error('Invalid phone number');\n  return `${digits.slice(0, 3)}-${digits.slice(3, 6)}-${digits.slice(6)}`;\n}\n\nfunction generateICS({ eventName, formattedEventDate, name, email }) {\n  const now = new Date();\n  const eventDate = new Date(formattedEventDate);\n  eventDate.setHours(16, 30);\n  const endDate = new Date(eventDate.getTime() + 2 * 60 * 60 * 1000);\n\n  const format = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';\n\n  return `\nBEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//MCMA Kitchen//EN\nCALSCALE:GREGORIAN\nMETHOD:REQUEST\nBEGIN:VEVENT\nDTSTART:${format(eventDate)}\nDTEND:${format(endDate)}\nDTSTAMP:${format(now)}\nSUMMARY:MCMA Kitchen – ${eventName}\nDESCRIPTION:Thanks for volunteering, ${name}!\nORGANIZER;CN=MCMA Kitchen:mailto:${process.env.ADMIN_EMAIL}\nATTENDEE;CN=${name};RSVP=TRUE:mailto:${email}\nLOCATION:MCMA Kitchen\nUID:${Date.now()}@mcmakitchen.org\nSTATUS:CONFIRMED\nSEQUENCE:0\nEND:VEVENT\nEND:VCALENDAR\n  `.trim();\n}\n\nfunction getGoogleCalendarURL({ eventName, eventDate, name }) {\n  const start = new Date(eventDate);\n  start.setHours(16, 30);\n  const end = new Date(start.getTime() + 2 * 60 * 60 * 1000);\n  const format = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';\n\n  const params = new URLSearchParams({\n    action: 'TEMPLATE',\n    text: `MCMA Kitchen – ${eventName}`,\n    dates: `${format(start)}/${format(end)}`,\n    details: `Volunteer sign-up for ${eventName}. Thanks, ${name}!`,\n    location: 'MCMA Kitchen',\n  });\n\n  return `https://www.google.com/calendar/render?${params.toString()}`;\n}\n\nexport async function POST(req) {\n  const timestamp = new Date().toISOString();\n\n  try {\n    const { eventName, eventDate, name, phone, email, token } = await req.json();\n\n    if (!eventName || !eventDate || !name || !phone || !email || !token) {\n      return new Response(JSON.stringify({ error: 'Missing fields' }), { status: 400 });\n    }\n\n    // ✅ Verify reCAPTCHA\n    const captchaRes = await fetch('https://www.google.com/recaptcha/api/siteverify', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n      body: new URLSearchParams({\n        secret: process.env.RECAPTCHA_SECRET_KEY,\n        response: token,\n      }),\n    });\n\n    const captchaResult = await captchaRes.json();\n\n    if (!captchaResult.success || captchaResult.score < 0.5) {\n      console.warn('⚠️ CAPTCHA verification failed', {\n        timestamp,\n        name,\n        email,\n        score: captchaResult.score,\n        action: captchaResult.action,\n        errorCodes: captchaResult['error-codes'],\n      });\n\n      return new Response(JSON.stringify({ error: 'Failed CAPTCHA verification' }), { status: 403 });\n    }\n\n    const formattedPhone = formatPhone(phone);\n\n    const auth = new google.auth.JWT(\n      process.env.GOOGLE_CLIENT_EMAIL,\n      null,\n      process.env.GOOGLE_PRIVATE_KEY.replace(/\\\\n/g, '\\n'),\n      ['https://www.googleapis.com/auth/spreadsheets']\n    );\n\n    const sheets = google.sheets({ version: 'v4', auth });\n    const sheetId = process.env.GOOGLE_SHEET_ID;\n\n    const now = new Date();\n    const formattedTimestamp = now.toLocaleString('en-US', {\n      timeZone: 'America/Los_Angeles',\n      weekday: 'long',\n      month: '2-digit',\n      day: '2-digit',\n      year: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n      hour12: true,\n    });\n\n    const formattedEventDate = new Date(eventDate).toLocaleDateString('en-US', {\n      timeZone: 'America/Los_Angeles',\n      weekday: 'long',\n      month: '2-digit',\n      day: '2-digit',\n      year: '2-digit',\n    });\n\n    const newRow = [\n      formattedTimestamp,\n      eventName,\n      formattedEventDate,\n      name,\n      formattedPhone,\n      email,\n    ];\n\n    await sheets.spreadsheets.values.append({\n      spreadsheetId: sheetId,\n      range: 'Volunteer Signups!A:F',\n      valueInputOption: 'USER_ENTERED',\n      insertDataOption: 'INSERT_ROWS',\n      requestBody: {\n        values: [newRow],\n      },\n    });\n\n    const resend = new Resend(process.env.RESEND_API_KEY);\n    const from = process.env.EMAIL_FROM;\n    const admin = process.env.ADMIN_EMAIL;\n    const replyTo = process.env.ADMIN_EMAIL;\n\n    const calendarICS = generateICS({ eventName, formattedEventDate, name, email });\n    const googleCalendarLink = getGoogleCalendarURL({ eventName, eventDate, name });\n\n    const htmlBody = `\n<div style=\"font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:#fff; padding:24px; border-radius:12px; border:1px solid #ddd; max-width:480px; margin:0 auto; font-size:16px; line-height:1.6;\">\n  <div style=\"text-align:center; margin-bottom:24px;\">\n    <img src=\"https://mcma.s3.us-east-1.amazonaws.com/mcmaLogo.png\" alt=\"MCMA Logo\" style=\"max-width:140px; height:auto;\" />\n  </div>\n  <h2 style=\"margin-bottom:12px;\">Thank you for signing up!</h2>\n  <p><strong>Event:</strong> ${eventName}</p>\n  <p><strong>Date:</strong> ${formattedEventDate}</p>\n  <p><strong>Name:</strong> ${name}</p>\n  <p><strong>Phone:</strong> ${formattedPhone}</p>\n  <p><strong>Email:</strong> ${email}</p>\n  <div style=\"margin-top:30px; text-align:center;\">\n    <a href=\"${googleCalendarLink}\" target=\"_blank\" style=\"text-decoration:none;\">\n      <button style=\"background:#4285F4; color:#fff; padding:10px 18px; font-size:15px; border:none; border-radius:6px; margin-right:12px; cursor:pointer;\">\n        Add to Google Calendar\n      </button>\n    </a>\n    <a href=\"cid:calendar\" download=\"mcma-volunteer.ics\">\n      <button style=\"background:#333; color:#fff; padding:10px 18px; font-size:15px; border:none; border-radius:6px; cursor:pointer;\">\n        Add to Apple Calendar\n      </button>\n    </a>\n  </div>\n</div>\n`;\n\n    const plainText = `\nThanks for signing up!\n\nEvent: ${eventName}\nDate: ${formattedEventDate}\nName: ${name}\nPhone: ${formattedPhone}\nEmail: ${email}\n`;\n\n    await resend.emails.send({\n      from,\n      to: email,\n      subject: `MCMA Kitchen – Thanks for signing up to help at the ${eventName} ${formattedEventDate}`,\n      html: htmlBody,\n      text: plainText,\n      reply_to: replyTo,\n      attachments: [\n        {\n          filename: 'mcma-volunteer.ics',\n          content: calendarICS,\n          contentType: 'text/calendar',\n          contentDisposition: 'inline',\n          cid: 'calendar',\n        },\n      ],\n    });\n\n    await resend.emails.send({\n      from,\n      to: admin,\n      subject: `New MCMA Volunteer Sign-Up: ${name} for ${eventName}`,\n      html: htmlBody,\n      text: plainText,\n      reply_to: replyTo,\n    });\n\n    return new Response(JSON.stringify({\n      status: 'OK',\n      submitted: { eventName, formattedEventDate, name, formattedPhone, email }\n    }), { status: 200 });\n\n  } catch (err) {\n    console.error('❌ Signup Error:', {\n      message: err.message,\n      stack: err.stack,\n      timestamp,\n      context: {\n        name: req?.body?.name,\n        email: req?.body?.email,\n        eventName: req?.body?.eventName,\n      },\n    });\n\n    return new Response(JSON.stringify({ error: err.message }), { status: 500 });\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}